<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“OPENæ¡‘ æˆ¿åƒ¹æ™‚å…‰æ©Ÿ</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; min-height: 100vh; }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full flex justify-center"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo } = React;
        
        // ==========================================
        // 1. Utils & Config
        // ==========================================
        
        const CONFIG = {
            LIFF_ID: "2008400942-nm4l6zlp",
            OFFICIAL_LINE_URL: "https://lin.ee/LTFdIJo",
            
            // [è³‡æ–™è»Œ] æˆ¿åƒ¹è³‡æ–™ Webhook (æœ‰å¿«å–æ©Ÿåˆ¶ï¼Œæ¯å¤©æ›´æ–°ä¸€æ¬¡)
            N8N_WEBHOOK_URL: "https://ez2.zeabur.app/webhook/650159db-37eb-4bfe-9aa1-01bed4d5b989",
            
            // [æ¬Šé™è»Œ] ä»˜è²»é©—è­‰ Webhook (ç„¡å¿«å–ï¼Œæ¯æ¬¡é–‹å•Ÿ APP å¼·åˆ¶æª¢æŸ¥)
            N8N_AUTH_URL: "https://ez2.zeabur.app/webhook/9af46c08-96e8-4c13-82a4-7e8339a656c8954", 
            
            // [åŠŸèƒ½] é–‹å•Ÿé€šçŸ¥
            N8N_ENABLE_NOTIFY_URL: "https://ez2.zeabur.app/webhook/a4153421-bf4d-4e40-a12c-0db94435a715",
            
            // [åŠŸèƒ½] é—œé–‰æ‰€æœ‰é€šçŸ¥
            N8N_DISABLE_NOTIFY_URL: "https://ez2.zeabur.app/webhook/384a9999-7e4b-43a4-90d6-daa868bd10ec",

            N8N_LOG_WEBHOOK_URL: "https://ez2.zeabur.app/webhook/log-event", 
            AGODA_CID: "1932313",
            AGODA_HOME: "https://www.agoda.com/",
            CACHE_KEY: "open_hotel_calendar_cache_v1",
            API_KEY: "vxjyMp3oAT6nH5VCwmwB2xi8cdXpvyrEqXG9Azbd" 
        };

        const CITY_RESOURCES = {
            'Tokyo': { agoda: "https://www.agoda.com/search?city=5085", article: "https://tahokkaido.com/tokyo-hotels-review/" },
            'Sapporo': { agoda: "https://www.agoda.com/search?city=3435", article: "https://tahokkaido.com/sapporohotels/" },
            'Osaka': { agoda: "https://www.agoda.com/search?city=9590", article: "https://tahokkaido.com/osaka-hotels-review/" },
            'Kyoto': { agoda: "https://www.agoda.com/search?city=1784", article: "https://tahokkaido.com/kyoto-hotels-review/" },
            'Fukuoka': { agoda: "https://www.agoda.com/search?city=16527", article: "https://tahokkaido.com/fukuoka-hotels-review/" },
            'Okinawa': { agoda: "https://www.agoda.com/search?city=717899", article: "https://tahokkaido.com/okinawa-hotels-review/" },
            'Nagoya': { agoda: "https://www.agoda.com/search?city=13740", article: "https://tahokkaido.com/nagoya-hotels-review/" },
            'Yokohama': { agoda: "https://www.agoda.com/search?city=4590", article: "https://tahokkaido.com/yokohama-hotels-review/" },
            'Sendai': { agoda: "https://www.agoda.com/search?city=10345", article: "https://tahokkaido.com/sendai-hotels-review/" },
            'Kumamoto': { agoda: "https://www.agoda.com/search?city=1568", article: "https://tahokkaido.com/kumamoto-hotels-review/" },
            'Seoul': { agoda: "https://www.agoda.com/search?city=14690", article: null },
            'Taipei': { agoda: "https://www.agoda.com/search?city=4951", article: null },
            'Taichung': { agoda: "https://www.agoda.com/search?city=12080", article: null },
            'Tainan': { agoda: "https://www.agoda.com/search?city=18347", article: null },
            'Kaohsiung': { agoda: "https://www.agoda.com/search?city=756", article: null },
            'Hualian': { agoda: "https://www.agoda.com/search?city=23127", article: null },
            'Taitung': { agoda: "https://www.agoda.com/search?city=4740", article: null },
            'Yilan': { agoda: "https://www.agoda.com/search?city=88773", article: null },
            'Jiayi': { agoda: "https://www.agoda.com/search?city=11977", article: null },
            'Kenting': { agoda: "https://www.agoda.com/search?city=18343", article: null },
            'Sun Moon Lake': { agoda: "https://www.agoda.com/search?city=18346", article: null }
        };

        const DateUtils = {
            formatLocalYYYYMMDD: (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            getDaysInMonth: (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay, year, month };
            },
            normalizeDate: (input) => {
                if (!input) return null;
                try {
                    const d = new Date(input);
                    if (isNaN(d.getTime())) return null;
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    return null;
                }
            },
            formatCurrency: (value) => {
                if (!value) return "";
                return new Intl.NumberFormat('zh-TW', { style: 'decimal', maximumFractionDigits: 0 }).format(value);
            },
            getNextNoonTimestamp: () => {
                const now = new Date();
                const noon = new Date();
                noon.setHours(12, 0, 0, 0);

                if (now >= noon) {
                    noon.setDate(noon.getDate() + 1);
                }
                return noon.getTime();
            }
        };

        // URL è™•ç†å·¥å…·
        const UrlUtils = {
            buildAgodaUrl: (baseUrl, checkInDate = null) => {
                let targetUrl = baseUrl;
                if (!targetUrl || targetUrl === "#" || targetUrl.trim() === "") {
                    targetUrl = CONFIG.AGODA_HOME;
                }
                
                try {
                    const url = new URL(targetUrl);
                    url.searchParams.set("cid", CONFIG.AGODA_CID);
                    if (checkInDate) {
                        url.searchParams.set("checkIn", checkInDate);
                        url.searchParams.set("los", "1");
                    }
                    return url.toString();
                } catch (e) {
                    let cleanUrl = targetUrl;
                    cleanUrl = cleanUrl.replace(/([?&])cid=[^&]*(&|$)/g, '$1');
                    if (cleanUrl.endsWith('?') || cleanUrl.endsWith('&')) {
                        cleanUrl = cleanUrl.slice(0, -1);
                    }
                    const separator = cleanUrl.includes('?') ? '&' : '?';
                    let params = `cid=${CONFIG.AGODA_CID}`;
                    if (checkInDate) params += `&checkIn=${checkInDate}&los=1`;
                    return `${cleanUrl}${separator}${params}`;
                }
            },
            openLink: (e, url) => {
                if (!url || url === "#") {
                    e.preventDefault();
                    return;
                }

                if (window.liff && window.liff.isInClient && window.liff.isInClient()) {
                    e.preventDefault();
                    window.liff.openWindow({
                        url: url,
                        external: true // å¼·åˆ¶ç”¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿï¼Œç¢ºä¿ Cookie
                    });
                }
            },
            getHeaderToken: () => {
                return CONFIG.API_KEY || "";
            }
        };

        const getTagFromPR = (pr) => {
            if (pr === null || pr === undefined || pr === "") return "âš ï¸ ç„¡æ•¸æ“š";
            const val = Number(pr);
            if (isNaN(val)) return "âš ï¸ ç„¡æ•¸æ“š";

            if (val <= 20) return "ğŸ”µä½é»";
            if (val <= 40) return "ğŸŸ¢ä¾¿å®œ";
            if (val <= 60) return "ğŸŸ¡æ­£å¸¸";
            if (val <= 80) return "ğŸŸ å°è²´";
            return "ğŸ”´éç†±";
        };

        const STYLES = {
            TAG: {
                "ğŸ”µä½é»": "bg-blue-50 text-blue-700 border-blue-200 ring-1 ring-blue-100",
                "ğŸŸ¢ä¾¿å®œ": "bg-green-50 text-green-700 border-green-200 ring-1 ring-green-100",
                "ğŸŸ¡æ­£å¸¸": "bg-yellow-50 text-yellow-700 border-yellow-200 ring-1 ring-yellow-100",
                "ğŸŸ å°è²´": "bg-orange-50 text-orange-700 border-orange-200 ring-1 ring-orange-100",
                "ğŸ”´éç†±": "bg-red-50 text-red-700 border-red-200 ring-1 ring-red-100",
                "DEFAULT": "bg-gray-50 text-gray-400 border-gray-100"
            }
        };

        const getTagStyle = (tag) => {
            if (!tag) return STYLES.TAG.DEFAULT;
            const found = Object.keys(STYLES.TAG).find(k => tag.includes(k));
            return found ? STYLES.TAG[found] : STYLES.TAG.DEFAULT;
        };

        // ==========================================
        // 2. UI Components
        // ==========================================

        const IconBase = memo(({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        ));

        // Icons
        const ChevronLeft = memo((props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>);
        const ChevronRight = memo((props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>);
        const ChevronDown = memo((props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>);
        const MapPin = memo((props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>);
        const Building2 = memo((props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>);
        const Snowflake = memo((props) => <IconBase {...props}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></IconBase>);
        const Utensils = memo((props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>);
        const Landmark = memo((props) => <IconBase {...props}><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></IconBase>);
        const Waves = memo((props) => <IconBase {...props}><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></IconBase>);
        const Palmtree = memo((props) => <IconBase {...props}><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1h1l1 1h4l1-1h1l1 1h2l1-1h1l1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1h-1l-1 1h-3"/><path d="M5.8 9.5a4 4 0 0 1 7.4 0"/><path d="M9 12v10"/></IconBase>);
        const Info = memo((props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>);
        const Sparkles = memo((props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></IconBase>);
        const ArrowRight = memo((props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>);
        const ExternalLink = memo((props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>);
        const Hotel = memo((props) => <IconBase {...props}><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 16a5 5 0 0 0-6 0"/><path d="M16 11h.01"/><path d="M16 7h.01"/><path d="M8 11h.01"/><path d="M8 7h.01"/><rect x="4" y="2" width="16" height="20" rx="2"/></IconBase>);
        const Loader2 = memo((props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>);
        const AlertCircle = memo((props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>);
        const CheckCircle = memo((props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconBase>);
        const Grid = memo((props) => <IconBase {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconBase>);
        const X = memo((props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></IconBase>);
        const TokyoTower = memo((props) => <IconBase {...props}><path d="M12 2L4 22h16L12 2zm0 6h-3l1-2.5h4L15 8h-3zm-5 7h10l1 2.5H6l1-2.5z"/></IconBase>);
        const Castle = memo((props) => <IconBase {...props}><path d="M4 22h16 M6 22v-6l6-3 6 3v6 M12 2l-3 4h6z M12 6v7"/></IconBase>);
        const Torii = memo((props) => <IconBase {...props}><path d="M4 5h16 M4 9h16 M7 5v17 M17 5v17 M2 5l2-2 M20 3l2 2"/></IconBase>);
        const Ramen = memo((props) => <IconBase {...props}><path d="M3 14h18v4a9 9 0 0 1-18 0z M6 14V6 M12 14V6 M18 14V6 M2 10h20"/></IconBase>);
        const Taipei101 = memo((props) => <IconBase {...props}><path d="M8 22v-4 M16 22v-4 M7 18h10l-1-4H8l-1 4z M7 14h10l-1-4H8l-1 4z M7 10h10l-1-4H8l-1 4z M9 6h6V2H9v4z"/></IconBase>);
        const Mountain = memo((props) => <IconBase {...props}><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></IconBase>);
        const Onsen = memo((props) => <IconBase {...props}><path d="M6 8c-1-2 2-4 2-4s3 2 2 4-2 4-4 4zm6 0c-1-2 2-4 2-4s3 2 2 4-2 4-4 4zm6 0c-1-2 2-4 2-4s3 2 2 4-2 4-4 4z M2 14h20v6a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4v-6z"/></IconBase>);
        const Anchor = memo((props) => <IconBase {...props}><path d="M12 2v18 M5 12H2a10 10 0 0 0 20 0h-3 M12 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></IconBase>);
        const Balloon = memo((props) => <IconBase {...props}><path d="M12 2a7 7 0 0 1 7 7c0 4-3 6-7 9-4-3-7-5-7-9a7 7 0 0 1 7-7z M10 20h4l1 2H9l1-2z"/></IconBase>);
        const Train = memo((props) => <IconBase {...props}><path d="M4 4h16c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M4 14h16 M2 14h20 M6 18l-2 3 M18 18l2 3 M8 8h8v4H8z"/></IconBase>);
        const Lighthouse = memo((props) => <IconBase {...props}><path d="M8 22h8 M9 22l2-14h2l2 14 M12 2l2 2h-4l2-2z M8 8h8"/></IconBase>);
        const Building = memo((props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4 M8 6h.01 M16 6h.01 M8 10h.01 M16 10h.01 M8 14h.01 M16 14h.01 M8 18h.01 M16 18h.01"/></IconBase>);
        
        // æ–°å¢ Bell Icon
        const Bell = memo((props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></IconBase>);
        const BellOff = memo((props) => <IconBase {...props}><path d="M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5" /><path d="M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /><path d="m2 2 20 20" /></IconBase>);

        const CITY_CATEGORIES = [
            {
                title: "æ—¥æœ¬ / éŸ“åœ‹",
                list: [
                    { id: 'Tokyo', name: 'æ±äº¬', icon: TokyoTower, color: 'text-red-500' },
                    { id: 'Sapporo', name: 'æœ­å¹Œ', icon: Snowflake, color: 'text-blue-400' },
                    { id: 'Osaka', name: 'å¤§é˜ª', icon: Castle, color: 'text-orange-500' },
                    { id: 'Kyoto', name: 'äº¬éƒ½', icon: Torii, color: 'text-red-700' },
                    { id: 'Fukuoka', name: 'ç¦å²¡', icon: Ramen, color: 'text-yellow-600' },
                    { id: 'Okinawa', name: 'æ²–ç¹©', icon: Palmtree, color: 'text-green-500' },
                    { id: 'Nagoya', name: 'åå¤å±‹', icon: Castle, color: 'text-yellow-700' },
                    { id: 'Kumamoto', name: 'ç†Šæœ¬', icon: Building2, color: 'text-red-500' },
                    { id: 'Sendai', name: 'ä»™å°', icon: Building2, color: 'text-emerald-600' },
                    { id: 'Yokohama', name: 'æ©«æ¿±', icon: Anchor, color: 'text-blue-600' },
                    { id: 'Seoul', name: 'é¦–çˆ¾', icon: Building, color: 'text-pink-600' },
                ]
            },
            {
                title: "å°ç£",
                list: [
                    { id: 'Taipei', name: 'å°åŒ—', icon: Taipei101, color: 'text-emerald-500' },
                    { id: 'Taichung', name: 'å°ä¸­', icon: MapPin, color: 'text-orange-500' },
                    { id: 'Kaohsiung', name: 'é«˜é›„', icon: Anchor, color: 'text-blue-600' },
                    { id: 'Tainan', name: 'å°å—', icon: Landmark, color: 'text-red-500' }, 
                    { id: 'Yilan', name: 'å®œè˜­', icon: Onsen, color: 'text-green-600' },
                    { id: 'Hualian', name: 'èŠ±è“®', icon: Mountain, color: 'text-emerald-600' },
                    { id: 'Taitung', name: 'å°æ±', icon: Balloon, color: 'text-orange-400' },
                    { id: 'Sun Moon Lake', name: 'æ—¥æœˆæ½­', icon: Mountain, color: 'text-blue-400' },
                    { id: 'Jiayi', name: 'å˜‰ç¾©', icon: Mountain, color: 'text-green-700' },
                    { id: 'Kenting', name: 'å¢¾ä¸', icon: Lighthouse, color: 'text-blue-500' },
                ]
            }
        ];

        const CITIES = CITY_CATEGORIES.flatMap(category => category.list);

        const DEFAULT_INSIGHTS = {
            ...CITIES.reduce((acc, city) => ({
                ...acc,
                [city.id]: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" }
            }), {})
        };

        const generateFallbackData = () => {
            const fallbackData = [];
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            
            for(let i=0; i<150; i++) { 
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                
                const row = { check_in: dateStr };
                CITIES.forEach((city, index) => {
                    const rand = (i + index) % 10; 
                    let heatIndex = 50;
                    if (rand < 2) heatIndex = 15;
                    else if (rand < 4) heatIndex = 35;
                    else if (rand > 7) heatIndex = 90;
                    else if (rand > 5) heatIndex = 70;

                    row[`${city.id}`] = heatIndex;
                });
                fallbackData.push(row);
            }
            
            const priceData = [];
            CITIES.forEach(city => {
                for (let m = 0; m < 6; m++) {
                    const d = new Date(start);
                    d.setMonth(start.getMonth() + m);
                    const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    
                    priceData.push({
                        region: city.id,
                        month: monthStr,
                        min_price_twd: 1500 + Math.floor(Math.random() * 1000),
                        max_price_twd: 5000 + Math.floor(Math.random() * 2000)
                    });
                }
            });

            return {
                calendar: fallbackData,
                prices: priceData,
                insights: DEFAULT_INSIGHTS
            };
        };

        // --- UI Components ---
        // [ä¿®æ”¹] Header ç¾åœ¨æ¥å— onOpenProModal å’Œ isPaidUser ç‹€æ…‹
        const Header = memo(({ onOpenCitySelector, onOpenProModal, isPaidUser }) => (
            <div className="px-4 py-3 bg-white flex-none flex items-center justify-between shadow-sm z-20 relative">
                <button 
                    onClick={onOpenProModal} 
                    className={`flex items-center gap-2 px-2 py-1.5 border rounded-full shadow-sm hover:shadow active:scale-95 transition-all group ${
                        isPaidUser 
                        ? "border-blue-200 bg-blue-50/30 hover:bg-blue-50" 
                        : "border-yellow-200 bg-yellow-50/30 hover:bg-yellow-50"
                    }`}
                >
                   <div className={`text-white p-1.5 rounded-full shadow-sm group-hover:rotate-12 transition-transform ${
                       isPaidUser ? "bg-gradient-to-tr from-blue-400 to-indigo-500" : "bg-gradient-to-tr from-yellow-400 to-amber-500"
                   }`}>
                        {isPaidUser ? <Bell size={20} /> : <Sparkles size={20} />}
                   </div>
                   <h1 className={`text-base font-bold pr-2 transition-colors ${
                       isPaidUser ? "text-gray-800 group-hover:text-blue-700" : "text-gray-800 group-hover:text-yellow-700"
                   }`}>
                       {isPaidUser ? "ç›£æ§è¨­å®š" : "é–‹å•ŸçœéŒ¢ç›£æ§"}
                   </h1>
                </button>
                <button 
                    onClick={onOpenCitySelector}
                    className="flex items-center gap-1.5 px-3 py-1.5 bg-gray-50 border border-gray-200 rounded-full hover:bg-gray-100 transition-colors text-gray-600 shadow-sm active:scale-95"
                    aria-label="é¸æ“‡åŸå¸‚"
                >
                    <Grid size={18} />
                    <span className="text-sm font-bold text-gray-700">é¸æ“‡åŸå¸‚</span>
                </button>
            </div>
        ));

        // --- CitySelectorModal ---
        const CitySelectorModal = memo(({ categories, selectedCity, onSelect, onClose }) => (
            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fade-in">
                <div className="absolute inset-0" onClick={onClose}></div>
                <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl relative z-10 max-h-[85vh] animate-fade-in-up flex flex-col shadow-2xl overflow-hidden">
                    <div className="flex justify-between items-center p-5 pb-3 border-b border-gray-100 bg-white flex-none z-20">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <MapPin size={20} className="text-red-500" />
                            é¸æ“‡ç›®çš„åœ°
                        </h3>
                        <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                            <X size={20} className="text-gray-600" />
                        </button>
                    </div>
                    <div className="overflow-y-auto flex-1 p-5 pt-2">
                        <div className="space-y-6 pb-4">
                            {categories.map((category, catIdx) => (
                                <div key={catIdx}>
                                    <h4 className="text-sm font-bold text-gray-500 mb-3 sticky top-0 bg-white/95 py-2 z-10 backdrop-blur-sm">
                                        {category.title}
                                    </h4>
                                    <div className="grid grid-cols-4 gap-y-4 gap-x-2">
                                        {category.list.map(city => (
                                            <button 
                                                key={city.id} 
                                                onClick={() => { onSelect(city); onClose(); }}
                                                className="flex flex-col items-center gap-2 group"
                                            >
                                                <div className={`p-3.5 rounded-2xl transition-all duration-200 ${selectedCity.id === city.id ? 'bg-red-50 border-2 border-red-200 shadow-md transform scale-105' : 'bg-gray-50 border border-gray-100 group-hover:bg-gray-100'}`}>
                                                    <city.icon size={26} className={selectedCity.id === city.id ? city.color : 'text-gray-400 group-hover:text-gray-500'} />
                                                </div>
                                                <span className={`text-xs font-medium text-center ${selectedCity.id === city.id ? 'text-gray-900 font-bold' : 'text-gray-500 group-hover:text-gray-700'}`}>
                                                    {city.name}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        ));

        // [æ–°å¢] FeedbackModal - è™•ç†çµæœå›é¥‹å½ˆçª—
        const FeedbackModal = memo(({ onClose, message, type }) => (
            <div className="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center animate-fade-in p-4">
                <div className="bg-white w-full max-w-sm rounded-2xl relative z-10 p-6 shadow-2xl animate-fade-in-up flex flex-col items-center text-center">
                    <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-lg ${type === 'success' ? 'bg-green-100 text-green-500' : 'bg-red-100 text-red-500'}`}>
                        {type === 'success' ? <CheckCircle size={32} /> : <AlertCircle size={32} />}
                    </div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">{type === 'success' ? 'è¨­å®šæˆåŠŸ' : 'è¨­å®šå¤±æ•—'}</h3>
                    <p className="text-gray-600 mb-6 leading-relaxed whitespace-pre-line">{message}</p>
                    <button onClick={onClose} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                        é—œé–‰
                    </button>
                </div>
            </div>
        ));

        // [æ–°å¢] MonitorModal - ä»˜è²»æœƒå“¡å°ˆç”¨è¨­å®šè¡¨å–®
        const MonitorModal = memo(({ onClose, onEnable, onDisableAll, cities, initialCityId, initialDate }) => {
            const [selectedMonitorCity, setSelectedMonitorCity] = useState(initialCityId || cities[0].id);
            const [selectedStartDate, setSelectedStartDate] = useState(initialDate || new Date().toISOString().split('T')[0]);
            const [selectedEndDate, setSelectedEndDate] = useState(initialDate || new Date().toISOString().split('T')[0]);
            const [targetPr, setTargetPr] = useState("80"); // æ–°å¢ PR å€¼ç‹€æ…‹ï¼Œé è¨­ 80

            // è‡ªå‹•ä¿®æ­£ï¼šé€€æˆ¿æ—¥ä¸èƒ½æ—©æ–¼å…¥ä½æ—¥
            useEffect(() => {
                if (selectedEndDate < selectedStartDate) {
                    const nextDay = new Date(selectedStartDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    setSelectedEndDate(nextDay.toISOString().split('T')[0]);
                }
            }, [selectedStartDate]);

            return (
                <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center animate-fade-in p-4">
                    <div className="absolute inset-0" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-sm rounded-2xl relative z-10 p-6 shadow-2xl animate-fade-in-up flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-50 rounded-full text-gray-400 hover:bg-gray-100">
                            <X size={20} />
                        </button>
                        
                        <div className="flex flex-col items-center mb-6">
                            <div className="w-14 h-14 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center mb-3 shadow-lg">
                                <Bell size={28} className="text-white" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-800">çœéŒ¢ç›£æ§è¨­å®š</h3>
                            <p className="text-sm text-gray-500 mt-1">è¨­å®šå€é–“ï¼Œé™åƒ¹ç«‹å³é€šçŸ¥</p>
                        </div>

                        <div className="space-y-4 mb-6">
                            <div className="space-y-1">
                                <label className="text-sm font-bold text-gray-700 ml-1">é¸æ“‡åŸå¸‚</label>
                                <div className="relative">
                                    <select 
                                        value={selectedMonitorCity}
                                        onChange={(e) => setSelectedMonitorCity(e.target.value)}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 font-medium"
                                    >
                                        {cities.map(city => (
                                            <option key={city.id} value={city.id}>{city.name}</option>
                                        ))}
                                    </select>
                                    <ChevronDown className="absolute right-3 top-3.5 text-gray-400 pointer-events-none" size={20} />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1">
                                    <label className="text-sm font-bold text-gray-700 ml-1">å…¥ä½æ—¥æœŸ</label>
                                    <input 
                                        type="date" 
                                        value={selectedStartDate}
                                        onChange={(e) => setSelectedStartDate(e.target.value)}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 font-medium text-sm"
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-sm font-bold text-gray-700 ml-1">é€€æˆ¿æ—¥æœŸ</label>
                                    <input 
                                        type="date" 
                                        value={selectedEndDate}
                                        min={selectedStartDate}
                                        onChange={(e) => setSelectedEndDate(e.target.value)}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 font-medium text-sm"
                                    />
                                </div>
                            </div>

                            {/* [æ–°å¢] PR å€¼é¸æ“‡æ¬„ä½ */}
                            <div className="space-y-1">
                                <label className="text-sm font-bold text-gray-700 ml-1">é€šçŸ¥é–€æª» (PRå€¼)</label>
                                <div className="relative">
                                    <select 
                                        value={targetPr}
                                        onChange={(e) => setTargetPr(e.target.value)}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 font-medium"
                                    >
                                        <option value="10">PR 10 (è¶…ç´šä¾¿å®œ)</option>
                                        <option value="20">PR 20 (å¾ˆä¾¿å®œ)</option>
                                        <option value="30">PR 30 (ä¾¿å®œ)</option>
                                        <option value="40">PR 40 (ä½æ–¼å¹³å‡)</option>
                                        <option value="50">PR 50 (å¹³å‡åƒ¹æ ¼)</option>
                                        <option value="60">PR 60 (ç•¥é«˜æ–¼å¹³å‡)</option>
                                        <option value="70">PR 70 (åè²´)</option>
                                        <option value="80">PR 80 (è²´)</option>
                                        <option value="90">PR 90 (éå¸¸è²´)</option>
                                    </select>
                                    <ChevronDown className="absolute right-3 top-3.5 text-gray-400 pointer-events-none" size={20} />
                                </div>
                                <p className="text-xs text-gray-400 ml-1 mt-1">ç•¶æˆ¿åƒ¹ä½æ–¼æ­¤ PR å€¼æ™‚ï¼Œæˆ‘å€‘å°‡ç™¼é€ LINE é€šçŸ¥ã€‚</p>
                            </div>
                        </div>

                        <div className="space-y-3">
                            <button 
                                onClick={() => onEnable(selectedMonitorCity, selectedStartDate, selectedEndDate, targetPr)}
                                className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2"
                            >
                                <Bell size={18} />
                                é–‹å•Ÿé€šçŸ¥
                            </button>
                            
                            <button 
                                onClick={onDisableAll}
                                className="w-full py-3 bg-white border border-red-200 text-red-500 rounded-xl font-bold hover:bg-red-50 active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                <BellOff size={18} />
                                é—œé–‰æ‰€æœ‰é€šçŸ¥
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // ProModal å…ƒä»¶ï¼Œé¡¯ç¤ºå‡ç´šè³‡è¨Šï¼Œæ–°å¢ onSubscribe
        const ProModal = memo(({ onClose, onSubscribe }) => (
            <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center animate-fade-in p-4">
                <div className="absolute inset-0" onClick={onClose}></div>
                <div className="bg-white w-full max-w-sm rounded-2xl relative z-10 p-6 shadow-2xl animate-fade-in-up flex flex-col items-center text-center">
                    <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-50 rounded-full text-gray-400 hover:bg-gray-100">
                        <X size={20} />
                    </button>
                    <div className="w-16 h-16 bg-gradient-to-br from-yellow-200 to-amber-400 rounded-full flex items-center justify-center mb-4 shadow-lg">
                        <Sparkles size={32} className="text-white" />
                    </div>
                    <h3 className="text-2xl font-bold text-gray-800 mb-2">ä¸å†èˆ‡æœ€ä½åƒ¹æ“¦èº«è€Œé</h3>
                    <br/>
                    <p className="text-gray-600 mb-6 leading-relaxed">
                        ç†±é–€æ—¥æœŸæˆ¿åƒ¹æ³¢å‹•å¤§ï¼ŒçŒ¶è±«ä¸€æ™šå¤šä»˜ $3,000<br/>
                        <span className="text-red-500 font-bold">çœéŒ¢ç›£æ§</span>ä¸€å¤©åªè¦ <span className="text-red-500 font-bold text-xl">5</span> å…ƒï¼<br/>
                        <span className="text-indigo-600 font-bold">é™åƒ¹å³æ™‚é€šçŸ¥ï¼šæˆ¿åƒ¹ä½æ–¼ PR 15 ç«‹å³æ¨æ’­ã€‚</span><br/>
                        <span className="text-indigo-600 font-bold">å…¨å¤©å€™è‡ªå‹•ç›¯ç›¤ï¼šæ©Ÿå™¨äººå¹«ä½ å®ˆè­·è·åŒ…ã€‚</span><br/>
                    </p>
                    <button onClick={onSubscribe} className="w-full py-3 bg-gradient-to-r from-gray-800 to-black text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                        é–‹å•ŸçœéŒ¢ç›£æ§
                    </button>
                </div>
            </div>
        ));

        const CityActionButtons = memo(({ insight, selectedCityName, selectedCityId, onAgodaClick, onArticleClick }) => {
            const handleAgodaClick = (e) => {
                const agodaBase = CITY_RESOURCES[selectedCityId]?.agoda;
                const finalUrl = UrlUtils.buildAgodaUrl(agodaBase);
                UrlUtils.openLink(e, finalUrl);
            };

            const handleArticleClick = (e) => {
                const url = CITY_RESOURCES[selectedCityId]?.article || "#";
                UrlUtils.openLink(e, url);
            }

            const showRecommendation = !!CITY_RESOURCES[selectedCityId]?.article;
            const agodaBase = CITY_RESOURCES[selectedCityId]?.agoda;
            const displayAgodaUrl = UrlUtils.buildAgodaUrl(agodaBase);

            return (
                <div className="px-2 mb-6 space-y-3">
                     <a 
                        href={displayAgodaUrl} 
                        target="_blank" 
                        rel="noopener noreferrer" 
                        onClick={handleAgodaClick} // æ”¹ç”¨å…§éƒ¨å®šç¾©çš„ handler
                        className="flex items-center justify-between w-full bg-white p-4 rounded-xl border border-red-100 shadow-sm hover:shadow-md active:scale-98 transition-all group cursor-pointer"
                      >
                        <div className="flex items-center gap-3">
                            <div className="bg-red-50 p-2.5 rounded-full text-red-600"><ExternalLink size={24} /></div>
                            <span className="font-bold text-lg text-gray-800 group-hover:text-red-600 transition-colors">ç«‹å³å» Agoda æ¶ä¾¿å®œ</span>
                        </div>
                        <ArrowRight size={20} className="text-gray-400 group-hover:text-red-500 transition-colors" />
                    </a>
                    
                    {showRecommendation && (
                         <a 
                            href={CITY_RESOURCES[selectedCityId]?.article || "#"} 
                            target="_blank"
                            rel="noopener noreferrer"
                            onClick={handleArticleClick}
                            className="flex items-center justify-between w-full bg-white p-4 rounded-xl border border-blue-100 shadow-sm hover:shadow-md active:scale-98 transition-all group cursor-pointer"
                          >
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-50 p-2.5 rounded-full text-blue-600"><Hotel size={24} /></div>
                                <span className="font-bold text-lg text-gray-800 group-hover:text-blue-600 transition-colors">{selectedCityName}ä½å®¿æ¨è–¦æ¸…å–®</span>
                            </div>
                            <ArrowRight size={20} className="text-gray-400 group-hover:text-blue-500 transition-colors" />
                        </a>
                    )}
                </div>
            );
        });

        const Navigator = memo(({ currentDate, onPrevMonth, onNextMonth }) => {
            const formatMonthTitle = (date) => `${date.getFullYear()}å¹´ ${date.getMonth() + 1}æœˆ`;
            return (
                <div className="flex items-center justify-between px-4 py-2 border-t border-gray-100 bg-white flex-none">
                    <button onClick={onPrevMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600"><ChevronLeft size={24} /></button>
                    <h2 className="text-lg font-bold text-gray-800">{formatMonthTitle(currentDate)}</h2>
                    <button onClick={onNextMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600"><ChevronRight size={24} /></button>
                </div>
            );
        });

        const WeekdayHeaders = memo(() => (
            <div className="bg-white grid grid-cols-7 border-b border-gray-100 pb-2 pt-1 flex-none">
                {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map((d, i) => (
                    <div key={d} className={`text-center text-sm font-bold ${i === 0 || i === 6 ? 'text-red-500' : 'text-gray-500'}`}>{d}</div>
                ))}
            </div>
        ));

        const CalendarGrid = memo(({ days, firstDay, year, month, data, selectedCityId, agodaBaseUrl, onDateClick }) => {
            const calendarCells = useMemo(() => {
                const cells = [];
                for (let i = 0; i < firstDay; i++) cells.push(null);
                for (let i = 1; i <= days; i++) cells.push(i);
                return cells;
            }, [days, firstDay]);

            return (
                <div className="grid grid-cols-7 gap-1 md:gap-2 mb-6 pt-2">
                    {calendarCells.map((day, idx) => {
                        if (!day) return <div key={`empty-${idx}`} className="h-[72px]"></div>;

                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const safeDateStr = DateUtils.normalizeDate(dateStr);
                        const dayData = data[safeDateStr]?.[selectedCityId];
                        
                        let tag = "âš ï¸ ç„¡æ•¸æ“š";
                        let indexVal = null;
                        
                        if (dayData && dayData.index !== null && dayData.index !== undefined) {
                            tag = getTagFromPR(dayData.index);
                            indexVal = dayData.index;
                        }

                        const displayTag = tag;
                        const displayIndex = dayData?.index;
                        const cellStyle = getTagStyle(tag);

                        const targetUrl = UrlUtils.buildAgodaUrl(agodaBaseUrl, safeDateStr);

                        return (
                            <a 
                                key={safeDateStr} 
                                href={targetUrl}
                                onClick={(e) => onDateClick(e, targetUrl, safeDateStr, indexVal)}
                                className={`h-[72px] flex flex-col justify-between p-1.5 rounded-lg border transition-all relative overflow-hidden cursor-pointer ${cellStyle} ${(tag === 'âš ï¸ ç„¡æ•¸æ“š') ? 'opacity-50 pointer-events-none' : 'hover:scale-105 shadow-sm'}`}
                            >
                                <span className={`text-sm font-semibold relative z-10 ${(tag === 'âš ï¸ ç„¡æ•¸æ“š') ? 'text-gray-400' : 'text-gray-600'}`}>{day}</span>
                                {tag !== "âš ï¸ ç„¡æ•¸æ“š" ? (
                                    <div className={`flex flex-col items-center justify-center h-full pb-4 gap-1 relative z-10`}>
                                        <span className="text-lg md:text-xl font-bold leading-tight text-center break-words w-full">{displayTag.substring(0, 2)}</span>
                                        {indexVal !== null && <span className="text-xs opacity-70 font-mono font-bold">{indexVal}</span>}
                                    </div>
                                ) : (
                                    <div className="h-full flex items-center justify-center relative z-10"><span className="text-xs text-gray-300">-</span></div>
                                )}
                            </a>
                        );
                    })}
                </div>
            );
        });

        // PriceRangeInfo Component
        const PriceRangeInfo = memo(({ minPrice, maxPrice }) => {
            if (!minPrice || !maxPrice) {
                return (
                    <div className="mx-2 mb-2 p-2 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center gap-2 text-xs text-gray-400">
                        <AlertCircle size={14} />
                        <span>æœ¬æœˆè³‡è¨Šé‡ä¸è¶³ï¼Œæ²’æœ‰æœ€ä½åƒ¹å’Œæœ€é«˜åƒ¹çš„çµ±è¨ˆ</span>
                    </div>
                );
            }
            return (
                <div className="mx-2 mb-2 p-2.5 bg-blue-50 border border-blue-100 rounded-lg flex flex-col items-center justify-center gap-1 text-sm text-blue-800 shadow-sm">
                    <div className="flex items-center gap-2 font-bold">
                        <span className="text-lg">ğŸ’°</span>
                        <span>æœ¬æœˆåƒ¹æ ¼å€é–“</span>
                    </div>
                    <div className="flex gap-4 text-sm font-medium">
                        <span className="text-green-600">æœ€ä½: ${DateUtils.formatCurrency(minPrice)}</span>
                        <span className="text-gray-300">|</span>
                        <span className="text-red-600">æœ€é«˜: ${DateUtils.formatCurrency(maxPrice)}</span>
                    </div>
                </div>
            );
        });

        const AnalysisSection = memo(({ insight, onToggle }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            
            const handleToggle = () => {
                const newState = !isExpanded;
                setIsExpanded(newState);
                if (newState) onToggle(); 
            };

            return (
                <div className="px-1">
                    <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden transition-all duration-200">
                        <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-purple-200 rounded-full opacity-20 blur-xl"></div>
                        
                        <button 
                            onClick={handleToggle}
                            className="w-full flex items-center justify-between p-4 relative z-10 text-left focus:outline-none"
                        >
                            <div className="flex items-center gap-2">
                                <div className="bg-white p-1.5 rounded-full shadow-sm border border-indigo-100">
                                    <Sparkles className="text-indigo-600" size={24} />
                                </div>
                                <h3 className="font-bold text-indigo-900 text-lg md:text-xl">OPENæ¡‘ æˆ¿åƒ¹åˆ†æ & å»ºè­°</h3>
                            </div>
                            <div className={`text-indigo-400 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                <ChevronDown size={24} />
                            </div>
                        </button>
                        
                        <div className={`relative z-10 px-4 transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[1000px] pb-4 opacity-100' : 'max-h-0 pb-0 opacity-0'}`}>
                            <div className="border-t border-indigo-200/50 pt-3">
                                <p className="text-base md:text-lg text-indigo-800 leading-relaxed text-justify whitespace-pre-line">
                                    {insight?.analysis || "æš«ç„¡åˆ†ææ•¸æ“š"}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        const Footer = memo(() => (
            <div className="px-4 py-6 text-center text-xs text-gray-400 border-t border-gray-100 mt-4 bg-gray-50/50">
                <p className="mb-1 font-medium text-gray-500">å…è²¬è²æ˜</p>
                <p className="leading-relaxed">
                    æœ¬æœå‹™åƒ…åˆ†æåœ°å€æ•´é«”æˆ¿åƒ¹è¶¨å‹¢ï¼Œæ•¸æ“šä¿‚ç”±ç³»çµ±æ¯æ—¥åˆ†æ 30,000+ ç­†è³‡æ–™è¨ˆç®—å¾—å‡ºï¼Œåƒ…ä¾›åƒè€ƒã€‚<br/>
                    å¯¦éš›æˆ¿åƒ¹æœƒéš¨è‘—é£¯åº—ç­‰ç´šã€ç©ºæˆ¿æ•¸ã€å®šåƒ¹ç­–ç•¥ç­‰å¤šç¨®å› ç´ è€Œæœ‰æ‰€å·®ç•°ã€‚<br/>
                    è³‡æ–™æœƒåœ¨æ¯å¤©ä¸­åˆ12é»æ›´æ–°ã€‚
                </p>
            </div>
        ));

        const JapanHotelCalendar = () => {
            const [data, setData] = useState({});
            const [priceStats, setPriceStats] = useState({});
            const [insights, setInsights] = useState(DEFAULT_INSIGHTS);
            const [loading, setLoading] = useState(true);
            const [selectedCity, setSelectedCity] = useState(CITIES[0]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [errorMsg, setErrorMsg] = useState(""); 
            const [showCitySelector, setShowCitySelector] = useState(false); 
            const [showProModal, setShowProModal] = useState(false);
            const [showMonitorModal, setShowMonitorModal] = useState(false); 
            const [userId, setUserId] = useState(null); 
            const [isPaidUser, setIsPaidUser] = useState(false); 
            
            // [æ–°å¢] Feedback Modal ç‹€æ…‹
            const [feedbackModal, setFeedbackModal] = useState({ show: false, message: '', type: 'success' });

            // --- æ ¸å¿ƒ Log å‡½å¼ ---
            const sendUserLog = useCallback((action, payload = {}, overrideCity = null) => {
                if (!CONFIG.N8N_LOG_WEBHOOK_URL) return;
                
                const logData = {
                    userId: userId || 'guest',
                    action: action,
                    city: overrideCity || selectedCity.name,
                    timestamp: new Date().toISOString(),
                    ...payload
                };
                
                const token = UrlUtils.getHeaderToken();
                
                try {
                    fetch(CONFIG.N8N_LOG_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-App-OPEN-san': token 
                        },
                        body: JSON.stringify(logData),
                        keepalive: true 
                    }).catch(e => console.warn("Log failed:", e));
                } catch(e) {}
            }, [userId, selectedCity]);

            // --- åµæ¸¬ LIFF èˆ‡ åˆå§‹åŒ– ---
            useEffect(() => {
                const initializeApp = async () => {
                    setLoading(true);
                    let uid = null;

                    // 1. LIFF Init
                    try {
                        if (window.liff) {
                            await liff.init({ liffId: CONFIG.LIFF_ID });

                            // === [æ–°å¢] ä¾†æºæª¢æŸ¥é‡å°å‘ ===
                            // é‚è¼¯ï¼šè‹¥éåœ¨ LINE App å…§ï¼Œä¸”ä¾†æºä¸æ˜¯ liff.line.me (LIFFè·³è½‰) æˆ– access.line.me (ç™»å…¥è·³è½‰)
                            // å‰‡è¦–ç‚ºç›´æ¥é–‹å•Ÿï¼Œå°å‘è¡ŒéŠ·é 
                            const isLineClient = liff.isInClient();
                            const referrer = document.referrer || "";
                            
                            // æª¢æŸ¥æ˜¯å¦ç‚º LIFF æˆ– Login æµç¨‹
                            const isValidSource = referrer.includes("liff.line.me") || referrer.includes("access.line.me");
                            
                            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ (è‹¥å·²ç™»å…¥é€šå¸¸ä»£è¡¨æ˜¯åˆæ³• Sessionï¼Œå¯å…è¨±é‡æ–°æ•´ç†)
                            const isLoggedIn = liff.isLoggedIn();

                            if (!isLineClient && !isValidSource && !isLoggedIn) {
                                // ç‚ºäº†é¿å…èª¤åˆ¤é–‹ç™¼ç’°å¢ƒ(localhost)ï¼Œé€šå¸¸æœƒåŠ  location.hostname !== 'localhost'
                                // ä½†ä¾ç…§ç”¨æˆ¶éœ€æ±‚ï¼Œç›´æ¥åŸ·è¡Œè·³è½‰
                                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                                     window.location.href = "https://tahokkaido.com/line-friend/";
                                     return; // ä¸­æ–·å¾ŒçºŒåŸ·è¡Œ
                                }
                            }
                            // ==========================

                            if (liff.isLoggedIn()) {
                                const profile = await liff.getProfile();
                                uid = profile.userId;
                                setUserId(uid);
                                console.log("LIFF User ID captured:", uid);
                            }
                        }
                    } catch (err) {
                        console.log("LIFF Init skipped/failed:", err);
                    }

                    // 2. [æ–°å¢] å˜—è©¦è®€å–å¿«å–
                    const cachedData = localStorage.getItem(CONFIG.CACHE_KEY);
                    let cachePayload = null;
                    let useCache = false;

                    if (cachedData) {
                        try {
                            const { expireAt, payload } = JSON.parse(cachedData);
                            const now = Date.now();
                            if (now < expireAt) {
                                console.log("[Cache] Hit! Using stored calendar data.");
                                cachePayload = payload;
                                useCache = true;
                            } else {
                                console.log("[Cache] Expired.");
                                localStorage.removeItem(CONFIG.CACHE_KEY); 
                            }
                        } catch (e) {
                            console.warn("Cache parse error:", e);
                            localStorage.removeItem(CONFIG.CACHE_KEY);
                        }
                    }

                    // 3. é›™è»Œåˆ¶ï¼šä¸¦è¡Œè™•ç†ã€Œè³‡æ–™ã€èˆ‡ã€Œæ¬Šé™ã€
                    
                    // å®šç¾©è³‡æ–™ç²å– (Calendar Data)
                    const fetchCalendarData = async () => {
                        if (useCache && cachePayload) {
                            return cachePayload; // ç›´æ¥å›å‚³å¿«å–
                        }
                        
                        // è‹¥ç„¡å¿«å–ï¼Œå‘¼å« webhook
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 20000); 
                        const token = UrlUtils.getHeaderToken();

                        const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-App-OPEN-san': token 
                            },
                            body: JSON.stringify({ userId: uid }), 
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const apiResponse = await response.json();
                        
                        // å¯«å…¥å¿«å–
                        try {
                            const nextNoon = DateUtils.getNextNoonTimestamp();
                            localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({
                                expireAt: nextNoon,
                                payload: apiResponse
                            }));
                        } catch (e) { console.warn("Failed to save cache:", e); }
                        
                        return apiResponse;
                    };

                    // å®šç¾©æ¬Šé™ç²å– (Auth Status) - æ°¸é ä¸å¿«å–
                    const fetchAuthStatus = async () => {
                        if (!CONFIG.N8N_AUTH_URL) return null; // è‹¥æœªè¨­å®š URL å‰‡è·³é
                        
                        try {
                            const token = UrlUtils.getHeaderToken();
                            const response = await fetch(CONFIG.N8N_AUTH_URL, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'X-App-OPEN-san': token 
                                },
                                body: JSON.stringify({ userId: uid })
                            });
                            if (response.ok) {
                                return await response.json(); // é æœŸå›å‚³ { isPaid: true/false }
                            }
                        } catch (e) {
                            console.warn("Auth check failed:", e);
                        }
                        return null;
                    };

                    // åŸ·è¡Œä¸¦è¡Œè«‹æ±‚
                    try {
                        const [calendarData, authData] = await Promise.all([
                            fetchCalendarData(),
                            fetchAuthStatus()
                        ]);

                        // è™•ç†æˆ¿åƒ¹è³‡æ–™
                        processCalendarData(calendarData);

                        // è™•ç†æ¬Šé™è³‡æ–™ (Auth Webhook å„ªå…ˆï¼Œè‹¥å¤±æ•—æˆ–ç„¡è¨­å®šï¼Œå‰‡é€€å›çœ‹ Calendar Data è£¡æ˜¯å¦æœ‰å¸¶ isPaid)
                        let finalIsPaid = false;
                        if (authData && typeof authData.isPaid === 'boolean') {
                            finalIsPaid = authData.isPaid;
                            console.log("[Auth] Verified via Auth Webhook:", finalIsPaid);
                        } else if (calendarData) {
                            // Fallback: æª¢æŸ¥ Calendar Data å…§æ˜¯å¦å¤¾å¸¶ isPaid (èˆŠé‚è¼¯ç›¸å®¹)
                            if (calendarData.isPaid === true) finalIsPaid = true;
                            else if (Array.isArray(calendarData) && calendarData[0]?.isPaid === true) finalIsPaid = true;
                            console.log("[Auth] Fallback to Calendar Data:", finalIsPaid);
                        }
                        setIsPaidUser(finalIsPaid);
                        setErrorMsg("");

                    } catch (error) {
                        console.warn("Init Error:", error);
                        setErrorMsg(error.message); 
                        processCalendarData(generateFallbackData());
                    } finally {
                        setLoading(false);
                    }
                };

                const processCalendarData = (apiResponse) => {
                    let rawCalendarData = [];
                    let rawPriceData = [];
                    let fetchedInsights = null;

                    if (apiResponse) {
                        if (Array.isArray(apiResponse)) {
                            if (apiResponse.length > 0 && apiResponse[0].calendar) {
                                rawCalendarData = apiResponse[0].calendar || [];
                                rawPriceData = apiResponse[0].prices || [];
                                fetchedInsights = apiResponse[0].insights || null;
                            } else {
                                rawCalendarData = apiResponse;
                            }
                        } else {
                             rawCalendarData = apiResponse.calendar || apiResponse.data || [];
                             rawPriceData = apiResponse.prices || [];
                             fetchedInsights = apiResponse.insights || null;
                        }
                    }
                    if (fetchedInsights) setInsights(prev => ({ ...prev, ...fetchedInsights }));

                    const formattedData = {};
                    rawCalendarData.forEach(row => {
                        const dateKey = DateUtils.normalizeDate(row.check_in);
                        if (!dateKey) return;
                        if (!formattedData[dateKey]) formattedData[dateKey] = {};
                        CITIES.forEach(city => {
                            const indexKey = city.id; 
                            let indexVal = row[indexKey];
                            if (indexVal !== undefined && indexVal !== null) {
                                indexVal = Number(indexVal);
                            } else {
                                indexVal = null;
                            }
                            formattedData[dateKey][city.id] = {
                                index: indexVal,
                                tag: null 
                            };
                        });
                    });
                    setData(formattedData);

                    const formattedPriceStats = {};
                    rawPriceData.forEach(item => {
                        const key = `${item.region}_${item.month}`; 
                        formattedPriceStats[key] = {
                            min: item.min_price_twd,
                            max: item.max_price_twd
                        };
                    });
                    setPriceStats(formattedPriceStats);
                };

                initializeApp();
            }, []);

            const handlePrevMonth = useCallback(() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1)), []);
            const handleNextMonth = useCallback(() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1)), []);
            
            // [Log] åŸå¸‚åˆ‡æ›
            const handleCitySelect = useCallback((city) => {
                setSelectedCity(city);
                sendUserLog('select_city', { target_city: city.name }, city.name);
            }, [sendUserLog]);
            
            const toggleCitySelector = useCallback(() => setShowCitySelector(prev => !prev), []);
            
            // [ä¿®æ”¹] ProModal/MonitorModal ç›¸é—œé‚è¼¯
            const handleOpenProModal = useCallback(() => {
                if (isPaidUser) {
                    // å¦‚æœæ˜¯ä»˜è²»æœƒå“¡ï¼Œæ‰“é–‹ç›£æ§è¨­å®š
                    setShowMonitorModal(true);
                } else {
                    // å¦‚æœæ˜¯å…è²»æœƒå“¡ï¼Œæ‰“é–‹æ¨éŠ·å½ˆçª—
                    sendUserLog('click_upgrade_pro');
                    setShowProModal(true);
                }
            }, [sendUserLog, isPaidUser]);

            const handleCloseProModal = useCallback(() => {
                setShowProModal(false);
            }, []);
            
            const handleCloseMonitorModal = useCallback(() => {
                setShowMonitorModal(false);
            }, []);

            const handleSubscribe = useCallback(() => {
                sendUserLog('click_subscribe_now');
                // æœªä¾†å¯åœ¨æ­¤åŠ å…¥è·³è½‰é‚è¼¯
            }, [sendUserLog]);

            // [æ–°å¢] ç›£æ§åŠŸèƒ½ï¼šé–‹å•Ÿé€šçŸ¥ (å« API ä¸²æ¥èˆ‡ UI å›é¥‹)
            const handleEnableNotification = useCallback(async (cityId, startDate, endDate, targetPr) => {
                sendUserLog('enable_notification', { target_city_id: cityId, start_date: startDate, end_date: endDate, target_pr: targetPr });
                
                // é—œé–‰ç›£æ§è¨­å®šçª—ï¼Œæº–å‚™é¡¯ç¤ºçµæœ
                setShowMonitorModal(false);
                
                const token = UrlUtils.getHeaderToken();
                
                try {
                    // å‘¼å«é–‹å•Ÿé€šçŸ¥ Webhook
                    const response = await fetch(CONFIG.N8N_ENABLE_NOTIFY_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-App-OPEN-san': token 
                        },
                        body: JSON.stringify({ 
                            userId: userId, // å‚³é€ç•¶å‰ userId
                            cityId: cityId, 
                            startDate: startDate,
                            endDate: endDate,
                            pr: targetPr // [æ–°å¢] å‚³é€ PR å€¼
                        })
                    });

                    if (response.ok) {
                        setFeedbackModal({ show: true, type: 'success', message: 'ç›£æ§è¨­å®šå·²æˆåŠŸé–‹å•Ÿï¼\nè‹¥æœ‰é™åƒ¹å°‡é€é LINE é€šçŸ¥æ‚¨ã€‚' });
                    } else {
                        throw new Error('API request failed');
                    }
                } catch (e) {
                    console.error("Enable notification failed:", e);
                    setFeedbackModal({ show: true, type: 'error', message: 'è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚' });
                }
            }, [sendUserLog, userId]);

            // [æ–°å¢] ç›£æ§åŠŸèƒ½ï¼šé—œé–‰æ‰€æœ‰é€šçŸ¥ (å« API ä¸²æ¥èˆ‡ UI å›é¥‹)
            const handleDisableAllNotifications = useCallback(async () => {
                sendUserLog('disable_all_notifications');
                
                setShowMonitorModal(false);
                
                const token = UrlUtils.getHeaderToken();

                try {
                    // å‘¼å«é—œé–‰æ‰€æœ‰é€šçŸ¥ Webhook
                    const response = await fetch(CONFIG.N8N_DISABLE_NOTIFY_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-App-OPEN-san': token 
                        },
                        body: JSON.stringify({ 
                            userId: userId // å‚³é€ç•¶å‰ userId
                        })
                    });

                    if (response.ok) {
                        setFeedbackModal({ show: true, type: 'success', message: 'æ‰€æœ‰é€šçŸ¥å·²æˆåŠŸé—œé–‰ï¼' });
                    } else {
                        throw new Error('API request failed');
                    }
                } catch (e) {
                    console.error("Disable notifications failed:", e);
                    setFeedbackModal({ show: true, type: 'error', message: 'è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚' });
                }
            }, [sendUserLog, userId]);

            // [æ–°å¢] é—œé–‰å›é¥‹å½ˆçª—
            const handleCloseFeedbackModal = useCallback(() => {
                setFeedbackModal(prev => ({ ...prev, show: false }));
            }, []);

            // [Log] æœˆæ›†é»æ“Š
            const handleDateClick = useCallback((e, url, dateStr, prValue) => {
                sendUserLog('click_date', { 
                    date: dateStr, 
                    pr_value: prValue 
                });
                UrlUtils.openLink(e, url);
            }, [sendUserLog]);

            // [Log] CTA é»æ“Š
            const handleAgodaClick = useCallback((e) => {
                const agodaBase = CITY_RESOURCES[selectedCity.id]?.agoda;
                const finalUrl = UrlUtils.buildAgodaUrl(agodaBase);
                sendUserLog('click_agoda', { url: finalUrl });
                UrlUtils.openLink(e, finalUrl);
            }, [selectedCity, sendUserLog]);

            const handleArticleClick = useCallback((e) => {
                const url = CITY_RESOURCES[selectedCity.id]?.article || "#";
                sendUserLog('click_article', { url: url });
                UrlUtils.openLink(e, url);
            }, [selectedCity, sendUserLog]);

            // [Log] åˆ†æå±•é–‹
            const handleAnalysisExpand = useCallback(() => {
                sendUserLog('expand_analysis');
            }, [sendUserLog]);


            const { days, firstDay, year, month } = useMemo(() => DateUtils.getDaysInMonth(currentDate), [currentDate]);
            const currentInsight = insights[selectedCity.id] || DEFAULT_INSIGHTS[selectedCity.id] || { analysis: "å°šç„¡æ•¸æ“š" };

            // è¨ˆç®—ç•¶å‰æœˆä»½åƒ¹æ ¼å€é–“
            const currentMonthPriceInfo = useMemo(() => {
                const yearStr = currentDate.getFullYear();
                const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
                const key = `${selectedCity.id}_${yearStr}-${monthStr}`;
                const stats = priceStats[key];
                if (stats) return { min: stats.min, max: stats.max };
                return { min: null, max: null };
            }, [currentDate, selectedCity.id, priceStats]);

            return (
                <div className="bg-white flex flex-col font-sans w-full max-w-md mx-auto shadow-none md:shadow-2xl overflow-hidden md:rounded-xl md:border md:border-gray-200 relative h-screen md:h-[850px]">
                    {/* [ä¿®æ”¹] å‚³é isPaidUser çµ¦ Header */}
                    <Header 
                        onOpenCitySelector={toggleCitySelector} 
                        onOpenProModal={handleOpenProModal} 
                        isPaidUser={isPaidUser}
                    />
                    <Navigator currentDate={currentDate} onPrevMonth={handlePrevMonth} onNextMonth={handleNextMonth} />
                    <WeekdayHeaders />

                    <div className="p-2 pb-32 overflow-y-auto flex-1 no-scrollbar relative"> 
                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-400 gap-3">
                                <Loader2 className="animate-spin" size={32} />
                                <span className="text-sm">æ­£åœ¨è¼‰å…¥æœ€æ–°æˆ¿åƒ¹...</span>
                            </div>
                        ) : (
                            <React.Fragment>
                                {errorMsg && (
                                    <div className="mx-2 mb-2 p-2 bg-yellow-50 border border-yellow-100 rounded-lg flex items-center gap-2 text-xs text-yellow-700">
                                        <AlertCircle size={14} />
                                        <span>é€£ç·šä¸ç©© ({errorMsg})<br/>ç›®å‰é¡¯ç¤ºå±•ç¤ºç”¨æ•¸æ“š</span>
                                    </div>
                                )}
                                <CalendarGrid 
                                    days={days} firstDay={firstDay} year={year} month={month} 
                                    data={data} selectedCityId={selectedCity.id} 
                                    agodaBaseUrl={CITY_RESOURCES[selectedCity.id]?.agoda}
                                    onDateClick={handleDateClick}
                                />
                            </React.Fragment>
                        )}

                        <PriceRangeInfo 
                            minPrice={currentMonthPriceInfo.min} 
                            maxPrice={currentMonthPriceInfo.max} 
                        />

                        <div className="mb-6 px-2">
                            <div className="flex items-center gap-2 mb-2 text-gray-500"><Info size={14} /><span className="text-[16px]">ç†±åº¦æŒ‡æ•¸è¶Šé«˜ä»£è¡¨æˆ¿åƒ¹è¶Šæ˜‚è²´</span></div>
                            <div className="flex justify-between gap-1 overflow-x-auto no-scrollbar">
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-blue-500"></span>ä½é»</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-green-500"></span>ä¾¿å®œ</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-yellow-500"></span>æ­£å¸¸</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-orange-500"></span>ç¨è²´</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-red-500"></span>éç†±</div>
                            </div>
                        </div>

                        <CityActionButtons 
                            insight={CITY_RESOURCES[selectedCity.id]} 
                            selectedCityName={selectedCity.name}
                            selectedCityId={selectedCity.id}
                            onAgodaClick={handleAgodaClick}
                            onArticleClick={handleArticleClick}
                        />

                        <AnalysisSection 
                            insight={currentInsight} 
                            onToggle={handleAnalysisExpand}
                        />

                        <Footer />
                    </div>

                    {showCitySelector && (
                        <CitySelectorModal 
                            categories={CITY_CATEGORIES}
                            selectedCity={selectedCity} 
                            onSelect={handleCitySelect} 
                            onClose={toggleCitySelector} 
                        />
                    )}

                    {/* [æ–°å¢] Modal é¡¯ç¤ºé‚è¼¯ */}
                    {showProModal && (
                        <ProModal onClose={handleCloseProModal} onSubscribe={handleSubscribe} />
                    )}
                    
                    {showMonitorModal && (
                        <MonitorModal 
                            onClose={handleCloseMonitorModal} 
                            onEnable={handleEnableNotification}
                            onDisableAll={handleDisableAllNotifications}
                            cities={CITIES}
                            initialCityId={selectedCity.id}
                            initialDate={new Date().toISOString().split('T')[0]} // å‚³éåˆå§‹æ—¥æœŸ
                        />
                    )}

                    {/* [æ–°å¢] Feedback Modal */}
                    {feedbackModal.show && (
                        <FeedbackModal 
                            message={feedbackModal.message} 
                            type={feedbackModal.type} 
                            onClose={handleCloseFeedbackModal} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JapanHotelCalendar />);
    </script>
</body>
</html>
